<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HelpChain - Sign Up</title>
</head>
<body>
  <h2>Sign Up to HelpChain</h2>

  <input type="text" id="name" placeholder="Name or Username" required />
  <input type="email" id="email" placeholder="Email" required />
  <input type="password" id="password" placeholder="Create Password" required />

  <select id="role">
    <option value="">Select Role</option>
    <option value="Donor">Donor</option>
    <option value="NGO">NGO</option>
  </select>

  <!-- OTP Flow -->
  <button id="sendOtpBtn">Send OTP</button>
  <input type="text" id="otp" placeholder="Enter OTP" style="display:none;" />
  <button id="verifyOtpBtn" style="display:none;">Verify OTP</button>
  <div id="otpStatus"></div>

  <!-- Wallet -->
  <button id="createWalletBtn" style="display:none;">Create Wallet</button>
  <div id="keys"></div>

  <!-- Final Sign Up -->
  <button id="finalSignUpBtn" style="display:none;">Sign Up</button>
  <div id="message"></div>

  <!-- ‚úÖ Login redirect -->
  <p>Already have an account? <a href="login.html" class="login-link">Login</a></p>

  <script>
    let otpVerified = false;
    let keysGenerated = false;
    let userDetails = {};

    const msg = (text, color = "black") => {
      const m = document.getElementById("message");
      m.innerText = text;
      m.style.color = color;
    };

    document.getElementById("sendOtpBtn").addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      if (!email) return msg("‚ùå Please enter your email.", "red");

      try {
        const res = await fetch("http://localhost:5000/api/send-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });

        const data = await res.json();
        if (res.ok) {
          msg(data.message, "green");
          document.getElementById("otp").style.display = "inline-block";
          document.getElementById("verifyOtpBtn").style.display = "inline-block";
        } else {
          msg(`‚ùå ${data.error}`, "red");
        }
      } catch (err) {
        msg("‚ùå Failed to send OTP. Check connection.", "red");
      }
    });

    document.getElementById("verifyOtpBtn").addEventListener("click", async () => {
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const role = document.getElementById("role").value;
      const otp = document.getElementById("otp").value.trim();

      if (!name || !email || !password || !role || !otp)
        return msg("‚ùå Fill all fields including OTP.", "red");

      userDetails = { name, email, password, role, otp };

      try {
        const res = await fetch("http://localhost:5000/api/verify-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(userDetails),
        });

        const data = await res.json();
        if (res.ok) {
          otpVerified = true;
          document.getElementById("otpStatus").innerText = "‚úÖ OTP Verified!";
          document.getElementById("createWalletBtn").style.display = "inline-block";

          // Clear OTP sent message after verification
          document.getElementById("sendOtpBtn").style.display = "none"; // Hide send OTP button
          document.getElementById("otp").style.display = "none"; // Hide OTP input field

          userDetails.publicKey = data.publicKey;
          userDetails.secretKey = data.secretKey;
        } else {
          document.getElementById("otpStatus").innerText = `‚ùå ${data.error}`;
        }
      } catch (err) {
        document.getElementById("otpStatus").innerText = `‚ùå Network error: ${err.message}`;
      }
    });

    document.getElementById("createWalletBtn").addEventListener("click", () => {
      if (!otpVerified || !userDetails.publicKey || !userDetails.secretKey) {
        return msg("‚ùå Cannot generate wallet. Verify OTP first.", "red");
      }

      keysGenerated = true;
      document.getElementById("keys").innerText =
        `üîë Public Key: ${userDetails.publicKey}\nüóùÔ∏è Secret Key: ${userDetails.secretKey}\n‚ö†Ô∏è Copy and save these keys securely.`;
      msg("‚úÖ Wallet created successfully!", "green");
      document.getElementById("finalSignUpBtn").style.display = "inline-block";
    });

    document.getElementById("finalSignUpBtn").addEventListener("click", () => {
      if (!otpVerified || !keysGenerated) {
        msg("‚ùå Please complete all steps before signing up.", "red");
        return;
      }
      window.location.href = "landing.html?status=success";
    });
  </script>
</body>
</html>
